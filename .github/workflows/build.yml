name: Build on Main

# Builds the app on every push to main and uploads as artifact
# For actual releases, create a tag (e.g., v1.0.0) to trigger release.yml

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  APP_NAME: ExitNoder
  SCHEME: ExitNoder
  
jobs:
  build:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
      
    - name: Show build environment
      run: |
        xcodebuild -version
        swift --version
      
    - name: Build app (unsigned for testing)
      run: |
        xcodebuild clean build \
          -scheme "${{ env.SCHEME }}" \
          -configuration Debug \
          -derivedDataPath ./DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
    
    - name: Run tests (if available)
      continue-on-error: true
      run: |
        xcodebuild test \
          -scheme "${{ env.SCHEME }}" \
          -derivedDataPath ./DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO || echo "No tests found or tests failed"
    
    - name: Archive app for artifact
      run: |
        xcodebuild archive \
          -scheme "${{ env.SCHEME }}" \
          -archivePath "${{ env.APP_NAME }}.xcarchive" \
          -configuration Release \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

        # Extract app
        mkdir -p build
        cp -R "${{ env.APP_NAME }}.xcarchive/Products/Applications/${{ env.APP_NAME }}.app" build/

        # Create ZIP
        cd build
        ditto -c -k --sequesterRsrc --keepParent "${{ env.APP_NAME }}.app" "../${{ env.APP_NAME }}.zip"
        cd ..

    - name: Upload build artifact
      id: upload-artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || format('dev-{0}', github.sha) }}
        path: ${{ env.APP_NAME }}.zip
        retention-days: 7

    - name: Comment on PR with download link
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const artifactName = `${{ env.APP_NAME }}-pr-${{ github.event.pull_request.number }}`;
          const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `âœ… Build succeeded!\n\nðŸ“¦ **[Download ${artifactName}](${runUrl}#artifacts)**\n\n_Artifact will be available for 7 days._`
          })

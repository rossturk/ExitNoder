name: Build and Release (Notarized)

# This workflow includes code signing and notarization for distribution outside the Mac App Store
# Requires: 
# - APPLE_DEVELOPER_CERTIFICATE_P12_BASE64: Base64 encoded .p12 certificate
# - APPLE_DEVELOPER_CERTIFICATE_PASSWORD: Password for the .p12 file
# - APPLE_DEVELOPER_ID: Your Apple Developer ID email
# - APPLE_APP_SPECIFIC_PASSWORD: App-specific password for notarization
# - APPLE_TEAM_ID: Your Apple Team ID

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  APP_NAME: ExitNoder
  SCHEME: ExitNoder
  
jobs:
  build-and-notarize:
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer
      
    - name: Import Code Signing Certificate
      env:
        CERTIFICATE_BASE64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        
        # Decode certificate
        echo -n "$CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
        
        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        # Import certificate to keychain
        security import $CERTIFICATE_PATH -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH
        
        # Enable codesigning from CLI
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        # Save keychain password for later steps
        echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
        echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
    
    - name: Build and Archive
      run: |
        xcodebuild clean archive \
          -scheme "${{ env.SCHEME }}" \
          -archivePath "${{ env.APP_NAME }}.xcarchive" \
          -configuration Release \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_ENTITLEMENTS=ExitNoder.entitlements \
          DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
          CODE_SIGN_IDENTITY="Developer ID Application" \
          CODE_SIGNING_REQUIRED=YES \
          CODE_SIGNING_ALLOWED=YES
    
    - name: Export app
      run: |
        mkdir -p build
        cp -R "${{ env.APP_NAME }}.xcarchive/Products/Applications/${{ env.APP_NAME }}.app" build/
    
    - name: Notarize app
      env:
        APPLE_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        # Create a ZIP for notarization
        ditto -c -k --sequesterRsrc --keepParent "build/${{ env.APP_NAME }}.app" "${{ env.APP_NAME }}-notarize.zip"
        
        # Submit for notarization
        xcrun notarytool submit "${{ env.APP_NAME }}-notarize.zip" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait
        
        # Staple the notarization ticket
        xcrun stapler staple "build/${{ env.APP_NAME }}.app"
    
    - name: Create DMG
      run: |
        brew install create-dmg
        
        create-dmg \
          --volname "${{ env.APP_NAME }}" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "${{ env.APP_NAME }}.app" 175 120 \
          --hide-extension "${{ env.APP_NAME }}.app" \
          --app-drop-link 425 120 \
          "${{ env.APP_NAME }}.dmg" \
          "build/" || hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder build -ov -format UDZO "${{ env.APP_NAME }}.dmg"
    
    - name: Notarize DMG
      env:
        APPLE_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        # Submit DMG for notarization
        xcrun notarytool submit "${{ env.APP_NAME }}.dmg" \
          --apple-id "$APPLE_ID" \
          --password "$APPLE_PASSWORD" \
          --team-id "$APPLE_TEAM_ID" \
          --wait
        
        # Staple the notarization ticket to DMG
        xcrun stapler staple "${{ env.APP_NAME }}.dmg"
    
    - name: Create ZIP
      run: |
        cd build
        ditto -c -k --sequesterRsrc --keepParent "${{ env.APP_NAME }}.app" "../${{ env.APP_NAME }}.zip"
        cd ..
    
    - name: Get version
      id: version
      run: |
        echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.APP_NAME }}.dmg
          ${{ env.APP_NAME }}.zip
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Installation
          
          ### Direct Download
          Download `${{ env.APP_NAME }}.dmg` and drag the app to your Applications folder.
          
          ### Using Homebrew
          ```bash
          brew install --cask exitnoder
          ```
          
          ## What's Changed
          See release notes below.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Cleanup
      if: always()
      run: |
        if [ -n "$KEYCHAIN_PATH" ]; then
          security delete-keychain $KEYCHAIN_PATH || true
        fi
